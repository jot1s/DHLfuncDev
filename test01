import http.client
import urllib.parse
import json

# Import modules for Excel handling
import openpyxl as xl_read
import xlsxwriter as xl_writer

path = "C:\\game\\DHLfuncDev\\DHL_API_Sheet.xlsx"
wb_obj = xl_read.load_workbook(path)
sheetName = "Sheet1"
baseRow = 1   ## base row start with row 2
sheet_obj = wb_obj[sheetName]   ## checking the sheet object in the page call "Sheet1"

def SendAPI(trackingNumber):
    params = urllib.parse.urlencode({
        # 'trackingNumber': '6921406671',
        'trackingNumber': "'" + str(trackingNumber) + "'",
        'service': 'express'
    })

    headers = {
        'Accept': 'application/json',
        'DHL-API-Key': 'apI1hL9eB7gG7b'
    }

    connection = http.client.HTTPSConnection("api-eu.dhl.com")

    connection.request("GET", "/track/shipments?" + params, "", headers)
    response = connection.getresponse()

    status = response.status
    reason = response.reason
    data = json.loads(response.read())

    print("Status: {} and reason: {}".format(status, reason))
    print(data)
    
    connection.close()
    return data

def CheckInfo_API(trackingNumber, x, y):
    print("trackingNumber: ", trackingNumber  , "Row: " ,x , "Column: " ,y)

    api_response = SendAPI(trackingNumber)
    # Access and process JSON data as needed
    shipments = api_response['shipments']
    for shipment in shipments:
        # print("Shipment ID:", shipment.get('id'))
        # status = shipment.get('status', {}).get('status') ## shipments status status
        status = shipment['status']['status'] ## shipments status status
        origin_address = shipment['origin']['address']['addressLocality']  # Corrected 'addressLocality'
        destination_address = shipment['destination']['address']['addressLocality']  # Corrected 'addressLocality'
        
        event = shipment['events'][0]  
    
        print("Status:", status , "OriginAddress:" , origin_address , "DestinationAddress:" , destination_address)
        WriteInfo_excel(x, 3 , status )  ## status column 3 = C
        WriteInfo_excel(x, 4 , origin_address )  ## status column 4 = D
        WriteInfo_excel(x, 5 , destination_address ) ## status column 5 = E
        WriteInfo_excel(x, 6 , str(event) )

def WriteInfo_excel(x, y, value):
    print("WriteInfo_excel: ", x, y, value)
    sheet_obj.cell(x, y).value = value
    wb_obj.save(path)


for i in range(1, 10):   ## for loop row to check trackingnumber is exist
    status_row = sheet_obj.cell( baseRow + i, 3).value
    trackingNumber_row  = sheet_obj.cell( baseRow + i, 1).value  
    # print("sheet_obj: ", sheet_obj.cell( baseRow + i, 3).value)  ##Checking Status
    
    if trackingNumber_row == None:
        break

    if status_row == None and trackingNumber_row != None:  ##  is None
        CheckInfo_API(sheet_obj.cell(baseRow + i, 1).value , baseRow + i, 1 )
    else:
        print("Status and TrackingNumber == None ", status_row)



#     if (sheet_obj[
#     print("sheet_obj: ", sheet_obj.cell(i, 1).value)  ## (1,1) output "Tracking Number" (A1)

# trackingNumber = sheet_obj.cell(2, 1).value
# print( "sheet_obj: ",  sheet_obj.cell(2, 1).value  )  ## (1,1) output "Tracking Number" (A1)


# params = urllib.parse.urlencode({
#     # 'trackingNumber': '6921406671',
#     # 'trackingNumber': "'" + str(trackingNumber) + "'",
#     'service': 'express'
# })

# headers = {
#     'Accept': 'application/json',
#     'DHL-API-Key': 'apI1hL9eB7gG7b'
# }

# connection = http.client.HTTPSConnection("api-eu.dhl.com")

# connection.request("GET", "/track/shipments?" + params, "", headers)
# response = connection.getresponse()

# status = response.status
# reason = response.reason
# data = json.loads(response.read())

# print("Status: {} and reason: {}".format(status, reason))
# print(data)

# connection.close()